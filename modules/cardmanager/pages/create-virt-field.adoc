= Добавление виртуального поля

Виртуальное поле представляет собой правило для формирования данных, которые физически не хранятся в самой карточке, но могут быть использованы при построении представлений (отчётов) с участием карточек такого типа.

.В качестве источника данных для виртуального поля могут выступать:
* Физическое поле самой карточки.
* Физическое поле карточки другого типа, которая связана с данной.
* Системные данные о карточке (например, дата последнего изменения).
* Результат вычислений, произведённых над любым из вышеперечисленных полей.

Виртуальные поля, определённые в схеме карточки, всегда доступны в рамках соответствующих секций в диалоге настройки представления. Дополнительные виртуальные поля могут быть добавлены из РМА.

.Чтобы добавить виртуальное поле карточки:
. Откройте настройки карточки (menu:Edit[Card Properties]).
. Вызовите команду _New Virtual Field_ из контекстного меню узла _Virtual Fields_ дерева объектов.
. Выберите добавленное виртуальное поле в дереве объектов.
+
.CardManager -- Добавление виртуального поля
image::user:new-virt-field.png[CardManager -- Добавление виртуального поля]
+
. Введите псевдоним виртуального поля в поле _Псевдоним_.
+
.Псевдоним виртуального поля должен отвечать следующим требованиям:
* Быть уникальным в рамках карточки.
* Содержать только латинские символы.
* Не содержать пробелы.
+
. Введите локализованные названия виртуального поля в таблице _Названия_.
. Введите локализованные описания виртуального поля, для отображения в подсказках к полю в диалогах поиска и представлений, в таблице _Description_.
. Выберите тип виртуального поля в списке _Тип_:
+
* *_int_* -- целое.
* *_bool_* -- булево значение.
* *_datetime_* -- дата и время.
* *_uniqueid_* -- уникальный идентификатор.
* *_string_* -- строка.
* *_unistring_* -- строка в формате Unicode.
* *_float_* -- число с плавающей точкой.
* *_unitext_* -- текст в формате Unicode.
* *_decimal_* -- десятичное число.
* *_binary_* -- двоичные данные.
+
. Выберите секцию, на основе данных которой строится виртуальное поле.
+
Из этой секции будут выбираться физические поля для вычислений, и к ней будут последовательно присоединяться другие секции или таблицы.
+
. В элементе _Определение поля_ выберите метод получения данных вычисляемого поля:
+
* _Поле секции_ -- физическое поле основной или присоединённой секции.
* _Вычисляемое поле_ -- вычисляемое поле по данным физического поля основной или присоединённой секции.
+
. В таблице _Присоединенные разделы_ определите связи основной секции виртуального поля с другими секциями или таблицами.
+
.. Кликните *Добавить*. Будет открыто диалоговое окно добавления присоединяемого раздела.
+
.CardManager -- Присоединение раздела
image::user:join-virt-field.png[CardManager -- Присоединение раздела]
+
.. Введите псевдоним присоединенного раздела в поле _Alias_.
.. Выберите оригинальную секцию и поле, по которому связываются секции, в полях _Source section_ и _Source field_.
.. Выберите присоединяемую секцию и поле, с которыми связываются секции, в полях _Target section_ и _Target field_.
.. Если необходимо, настройте условия фильтрации записей присоединённой секции в поле _Conditions_.
. Нажмите кнопку *Изменить*, расположенную справа от элемента _Определение поля_. Будет открыто окно настройки виртуального поля:
+
* Если в элементе _Определение поля_ выбран режим *Поле секции*, укажите поле основной или присоединенной секции, из которого будут получены данные виртуального поля.
+
.CardManager -- Выбор поля секции
image::user:add-virtual-field.png[CardManager -- Выбор поля секции]
+
* Если в элементе _Определение поля_ выбран режим *Вычисляемое поле*, настройте вычисляемое поле.
+
.CardManager -- Добавление вычисляемого поля
image::user:add-computed-field.png[CardManager -- Добавление вычисляемого поля]
+
Описание вычисляемого поля по сути представляет собой совокупность атомарных операций (элементов), выполняющихся в определённом порядке, который задаётся через иерархические группы. Внутри каждой группы элементы могут объединяться арифметической операцией (`+`, `-`, `\*`, `/`), логической операцией (`AND`, `OR`) или агрегацией.
+
Вычисления одного уровня исполняются строго последовательно, поэтому важно контролировать порядок их выполнения. Для этого можно перемещать элементы внутри группы кнопками *Up* и *Down*.
+
.Чтобы настроить вычисляемое поле:
.. Выберите тип данных, возвращаемых при вычислении, в поле _Result type_.
.. Если требуется создать группу операций, нажмите кнопку *Add group*.
.. Чтобы добавить атомарную операцию, нажмите кнопку *Add item*.
+
При добавлении атомарной операции в существующую по умолчанию группу, необходимо выбрать тип элементов данной операции:
+
* *_Simple_* -- значение физического поля секции, предопределённое значение или результат применения к нему простейшей функции.
* *_Switch_* -- результат селекции, сопоставляющей конкретным данным физического поля предопределённые значения.
* *_Conditions_* -- условный оператор, формирующий значение элемента в зависимости от значений других элементов.

.CardManager -- Добавление операции для вычисляемого поля
image::user:computed-field-operation.png[CardManager -- Добавление операции для вычисляемого поля]

Важно контролировать типы конкретных элементов вычислений и их групп, чтобы избежать ошибок в вычислениях, и получить правильный тип результирующего значения.

= Добавление отчетов

Отчёты -- хранимые процедуры БД, которые могут использоваться для прямого обращения к БД, минуя объектную модель и средства безопасности {dv}. Использования отчётов позволяет (в некоторых случаях) ускорить доступ к данным, получить сложную выборку данных, получить данные из сторонней базы данных или сервера и т.п.

[WARNING]
====
Методы, предоставляемые отчетами, выполняются вне моделей безопасности {dv}, поэтому программист должен самостоятельно обеспечить необходимые ограничения.
====

Хранимая процедура отчет имеет определенный набор входных и выходных параметров, а также уникальный идентификатор, по которому данный отчет может быть вызван.

Ниже приведён код примера отчёта для {mssql} и {pgsql}, возвращающего список замещаемых сотрудников, для которых `@EmployeeID` указан заместителем в Справочнике сотрудников.

.Версия для СУБД {mssql}
[source,sql]
----
BEGIN
 SELECT [RowID], [ParentRowID], [IsNotified]
 FROM  [dbo].[dvtable_{ED414CB4-B205-4BE4-A2FA-5C0D3347CEB3}] WITH(NOLOCK)
 WHERE [DeputyID] = @EmployeeID
END
----

.Версия для СУБД {pgsql}
[source,pgsql]
----
$$
BEGIN
    RETURN query
    SELECT tDeputies."RowID", tDeputies."ParentRowID", tDeputies."IsNotified"::integer
    FROM  public."dvtable_{ed414cb4-b205-4be4-a2fa-5c0d3347ceb3}" tDeputies
    WHERE tDeputies."DeputyID" = val_EmployeeID;
END;
$$
LANGUAGE plpgsql volatile;
----

.Чтобы добавить новый отчет в библиотеку карточек:
. Создайте файл отчета с хранимой процедурой (пример приведен выше) для Microsoft SQL и/или {pgsql} (в зависимости от целевой СУБД).
+
Файл(ы) нужно разместить в одном каталоге (или в подкаталоге) с файлом схемы библиотеки карточек.
+
. Откройте настройки библиотеки карточек (menu:Edit[Library Properties]).
. Перейдите на страницу настройки отчетов _Reports_.
+
.Страница настройки отчетов
image::user:cardman-reports.png[Страница настройки отчетов]

[start=4]
.Чтобы настроить основные параметры отчета:
. Нажмите кнопку *Add* в разделе _Procedures_. В список _Procedures_ будет добавлена новая запись.
. В поле _Alias_ введите псевдоним отчета, по которому данный отчет может быть вызван с помощью API {dv}.
. В таблице _Названия_ введите локализованные названия отчета.
+
.Пример настройки основных параметров отчета
image::user:report-parameters.png[Пример настройки основных параметров отчета]

[start=7]
.Укажите SQL-файлы c разработанными хранимыми процедурами:
. На странице _Reports_ откройте вкладку _SQL files_ .
. Нажмите на кнопку *Add* на вкладке _SQL files_. В список _Files_ будет добавлена новая запись.
. В поле _SQL file_ выберите SQL-файл, содержащий хранимую процедуру. После добавления путь необходимо изменить на относительный (относительно файла схемы библиотеки карточек).
. В поле _Server type_ выберите тип СУБД, для которой предназначен файл: Microsoft SQL или {pgsql}.
+
[NOTE]
====
Типы СУБД Oracle и MySQL, представленные в списке, не поддерживаются системой {dv}.
====
+
. Если требуется ограничить применение SQL-файла версией СУБД, укажите её в поле _Server version_.
+
Если версия не указана, хранимая процедура может быть загружена в БД, работающую под управлением СУБД любой версии.
+
.Пример настройки файлов отчета
image::user:report-files.png[Пример настройки файлов отчета]
+
. Если требуется, добавьте аналогичным образом другие файлы отчетов.
. Если хранимая процедура принимает входящие параметры, настройте их на вкладке "Parameters":
.. На странице _Reports_ откройте вкладку _Parameters_.
.. Нажмите на кнопку *Add*. В список _Parameters_ будет добавлена новая запись.
.. В поле _Parameter name_ введите название параметра, принимаемого хранимой процедурой.
.. Выберите тип параметра в списке `Parameter type`.
+
.Пример настройки параметров отчета
image::user:report-incoming-parameters.png[Пример настройки параметров отчета]
+
.. Если требуется, аналогичным образом добавьте другие параметры хранимой процедуры.

. Если хранимая процедура возвращает значения, настройте их на вкладке _Report result_.
.. На странице _Reports_ откройте вкладку _Report result_.
.. Выберите формат возвращаемого значения:
+
* _Scalar result_ -- если хранимая процедура возвращает единичное значение.
* _TableResult_ -- если хранимая процедура возвращает набор значений.
+
.. Для варианта *Scalar result*:
... Выберите тип возвращаемого значения в списке _Data type_.
... Настройте значения: _Precision_ и _Scale_ (только для полей с плавающей точкой), _Size_ (максимальный размер), _Nullable_ (может быть пустым).
... Нажмите кнопку *Add*. В таблицу _Columns_ будет добавлена новая запись.
.. Для варианта *TableResult*:
... Нажмите на кнопку *Add* на вкладке _Report result_. В таблицу _Columns_ будет добавлена новая запись.
... Введите название колонки с возвращаемым значением в поле _Name_.
... Выберите тип возвращаемого значения в списке _Data type_.
... Настройте параметры: _Precision_ и _Scale_, _Size_, _Nullable_.
... Если требуется, аналогичным образом настройте параметры других возвращаемых колонок.
+
.Пример настройки параметров возвращаемого значения
image::user:report-result.png[Пример настройки параметров возвращаемого значения]
